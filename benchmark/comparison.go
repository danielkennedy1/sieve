package benchmark

import (
	"bufio"
	"fmt"
	"math"
	"math/rand/v2"
	"os"
	"time"

	"github.com/danielkennedy1/sieve/config"
	"github.com/danielkennedy1/sieve/genomes"
	"github.com/danielkennedy1/sieve/problems/grammar"
)

type AgentStats struct {
	Name        string
	Count       int
	TotalCash   float64
	TotalStock  int
	TotalWealth float64
	TotalFit    float64
	TotalSharpe float64
}

func RunComparison() {
	config, err := config.LoadConfig("compare")
	if err != nil {
		fmt.Printf("Fatal error loading configuration: %v\n", err)
		os.Exit(1)
	}

	f, err := os.Open(config.BNFFilePath)
	if err != nil {
		fmt.Printf("File not found: %s\n", config.BNFFilePath)
		os.Exit(1)
	}
	defer f.Close()

	s := bufio.NewScanner(f)
	gr := grammar.Parse(*s)
	gr.BuildRuleMap()
	r := rand.New(rand.NewPCG(uint64(time.Now().UnixNano()), 100))

	simulator := &grammar.MarketSimulator{
		Results: nil,
		Config: &grammar.MarketConfig{
			Grammar:                              gr,
			MaxGenes:                             config.MaxGenes,
			InitialPrice:                         config.Market.InitialPrice,
			InitialFunds:                         config.Market.InitialFunds,
			InitialHoldings:                      config.Market.InitialHoldings,
			RoundsPerSim:                         config.Market.RoundsPerGeneration,
			NoiseOrdersPerRound:                  config.Market.NoiseOrdersPerRound,
			SimsPerGeneration:                    config.Market.SimsPerGeneration,
			FundamentalValueChangesPerSimulation: config.Market.FundamentalValueChangesPerSimulation,
			DemandPushCoefficient:                config.Market.DemandPushCoefficient,
			FundamentalPullCoefficient:           config.Market.FundamentalPullCoefficient,
			RSIPeriod:                            config.Market.RSIPeriod,
			ATRPeriod:                            config.Market.ATRPeriod,
			SMAPeriod:                            config.Market.SMAPeriod,
		},
		History:    &grammar.MarketHistory{},
		Rng:        r,
		Generation: 0,
	}

	bestStrategy := config.BestStrategy

	strategicTypes := []struct {
		Name     string
		Strategy string
	}{
		{Name: "Best GA", Strategy: bestStrategy},
		{Name: "Buy & Hold", Strategy: `(true) ? "BUY 5" : "SELL 0"`},
		{Name: "Simple", Strategy: `($PRICE <= 110) ? "BUY 5" : "SELL 5"`},
		{Name: "Random", Strategy: `($RANDOM >= 0.5) ? "BUY 1" : "SELL 1"`},
	}

	clonesPerType := 5
	numStrategic := len(strategicTypes) * clonesPerType

	numNoise := config.Market.NoiseOrdersPerRound
	totalAgents := numStrategic + numNoise

	fmt.Println("\n=== Starting Comparison Benchmark ===")
	fmt.Printf("Market Rounds: %d\n", config.Market.RoundsPerGeneration)
	fmt.Printf("Initial Funds: $%.2f\n", config.Market.InitialFunds)
	fmt.Printf("Population Split: %d Strategic (%.2f%%) / %d Noise (%.2f%%) = %d Total\n", numStrategic, (float64(numStrategic)/float64(totalAgents))*100, numNoise, (float64(numNoise)/float64(totalAgents))*100, totalAgents)

	var genotypes []genomes.Genotype

	createAgent := func(name, strategy string) {
		g := genomes.NewCreateGenotype(1, r, make(map[string]any))()
		g.Attributes["HardcodedStrategy"] = strategy
		g.Attributes["AgentType"] = name
		g.Attributes["cash"] = config.Market.InitialFunds
		g.Attributes["holdings"] = config.Market.InitialHoldings
		genotypes = append(genotypes, g)
	}

	for _, agent := range strategicTypes {
		for i := 0; i < clonesPerType; i++ {
			createAgent(agent.Name, agent.Strategy)
		}
	}

	start := time.Now()
	simulator.BeforeGeneration(&genotypes)
	elapsed := time.Since(start)

	numSims := len(simulator.MarketStates)
	if numSims == 0 {
		fmt.Println("CRITICAL ERROR: No market states were generated by the simulator. Check market.go.")
		return
	}

	for i, g := range genotypes {
		totalFinalCash := 0.0
		totalFinalHoldings := 0

		for simIdx := 0; simIdx < numSims; simIdx++ {
			marketState := simulator.MarketStates[simIdx]

			participantID := g.Attributes["id"].(int)
			finalParticipantState := marketState.Participants[participantID]

			totalFinalCash += finalParticipantState.Funds
			totalFinalHoldings += finalParticipantState.Holdings
		}

		avgFinalCash := totalFinalCash / float64(numSims)
		avgFinalHoldings := totalFinalHoldings / numSims

		g.Attributes["cash"] = avgFinalCash
		g.Attributes["holdings"] = avgFinalHoldings
		genotypes[i] = g

	}

	reportingFinalPrice := simulator.MarketStates[0].Price

	fmt.Printf("\n=== Results (Sim Time: %s) ===\n", elapsed)
	fmt.Printf("Final Market Price (Reported from Sim 0): $%.2f (Change: %.2f%%)\n",
		reportingFinalPrice,
		((reportingFinalPrice-config.Market.InitialPrice)/config.Market.InitialPrice)*100,
	)
	fmt.Println("-------------------------------------------------------------------------------------------------------")
	fmt.Printf("%-15s | %-6s | %-14s | %-12s | %-14s | %-11s | %-8s\n",
		"Agent Type", "Count", "Avg Wealth", "Avg Cash", "Avg Holdings", "Avg Fit", "Avg Sharpe")
	fmt.Println("-------------------------------------------------------------------------------------------------------")

	stats := make(map[string]*AgentStats)
	allNames := []string{}
	for _, a := range strategicTypes {
		stats[a.Name] = &AgentStats{Name: a.Name}
		allNames = append(allNames, a.Name)
	}

	fitnessFunc := simulator.NewMarketFitness()

	for _, g := range genotypes {
		typeName := g.Attributes["AgentType"].(string)

		s, ok := stats[typeName]
		if !ok {
			continue
		}

		cash := g.Attributes["cash"].(float64)
		holdings := g.Attributes["holdings"].(int)

		wealth := cash + float64(holdings)*reportingFinalPrice
		fitness := fitnessFunc(g)

		s.Count++
		s.TotalCash += cash
		s.TotalStock += holdings
		s.TotalWealth += wealth

		if !math.IsNaN(fitness) && !math.IsInf(fitness, 0) {
			s.TotalFit += fitness
		}

		// Add Sharpe ratio calculation
		if idAny, ok := g.Attributes["id"]; ok {
			id := idAny.(int)
			sharpe := simulator.Results[id].SharpeRatio
			if !math.IsNaN(sharpe) && !math.IsInf(sharpe, 0) {
				s.TotalSharpe += sharpe
			}
		}
	}

	for _, name := range allNames {
		s := stats[name]
		if s.Count == 0 {
			continue
		}

		avgWealth := s.TotalWealth / float64(s.Count)
		avgCash := s.TotalCash / float64(s.Count)
		avgHoldings := float64(s.TotalStock) / float64(s.Count)
		avgFit := s.TotalFit / float64(s.Count)
		avgSharpe := s.TotalSharpe / float64(s.Count)

		fmt.Printf("%-15s | %-6d | $%-13.2f | $%-11.2f | %-14.1f | %-11.4f | %-11.4f |\n",
			s.Name, s.Count, avgWealth, avgCash, avgHoldings, avgFit, avgSharpe)
	}
	fmt.Println("-------------------------------------------------------------------------------------------------------")
	simulator.History.ExportJSON("comparison_history.json")
	fmt.Println("\nHistory exported to comparison_history.json")
}
